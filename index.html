<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteora DLMM Pools</title>
    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css?family=inter:400,500,600,700,800|spectral:300i,400i,500i,600i|henny-penny:400|zilla-slab-highlight:400,700|libre-barcode-39-text:400" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            padding: 32px 20px;
            line-height: 1.5;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 48px 0 16px;
            margin-bottom: 24px;
            position: relative;
        }

        h1 {
            font-family: 'Spectral', serif;
            font-size: 8vw;
            font-weight: 500;
            font-style: italic;
            background: linear-gradient(135deg, #ffffff 0%, #b0b0b0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            letter-spacing: 0.02em;
            line-height: 1.1;
        }

        .subtitle {
            margin-top: 24px;
            margin-bottom: 8px;
            color: #6b6b6b;
            font-size: 1.125em;
            font-weight: 500;
            letter-spacing: -0.01em;
        }

        .loading {
            text-align: center;
            padding: 80px;
            font-size: 1em;
            color: #6b6b6b;
            font-weight: 500;
        }

        .console-box {
            max-width: 800px;
            margin: 24px auto 0;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #00ff00;
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .console-box::-webkit-scrollbar {
            width: 8px;
        }

        .console-box::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        .console-box::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        .console-line {
            margin: 4px 0;
            line-height: 1.4;
            word-break: break-all;
        }

        .console-line.success {
            color: #00ff00;
        }

        .console-line.info {
            color: #00bfff;
        }

        .console-line.warning {
            color: #ffaa00;
        }

        .console-line.error {
            color: #ff4444;
        }

        .console-timestamp {
            color: #666;
            margin-right: 8px;
        }

        /* Mobile Responsive Design */
        @media screen and (max-width: 768px) {
            body {
                padding: 16px 12px;
            }

            h1 {
                font-size: 12vw;
            }

            .subtitle {
                font-size: 1em;
            }

            header {
                padding: 24px 0 12px;
                margin-bottom: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                padding: 16px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 1.5em;
            }

            .stat-label {
                font-size: 0.8em;
            }

            .controls {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .search-box {
                width: 100%;
            }

            .timeframe-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }

            .timeframe-btn {
                flex: 1 1 auto;
                min-width: 60px;
                padding: 8px 12px;
            }

            .table-header {
                font-size: 0.75em;
                padding: 12px 8px;
            }

            .header-cell {
                padding: 0 4px;
            }

            .table-row {
                font-size: 0.85em;
                padding: 12px 8px;
                grid-template-columns: 2fr 1fr 1fr 1fr 32px;
            }

            .pool-name-cell {
                font-size: 0.9em;
            }

            .pool-name {
                font-size: 1em;
            }

            .pool-details {
                font-size: 0.75em;
            }

            .token-icons-pair {
                width: 40px;
                height: 24px;
            }

            .token-icon {
                width: 24px;
                height: 24px;
            }

            .token-icon-fallback {
                width: 24px;
                height: 24px;
                font-size: 0.6em;
            }

            .metric-label {
                font-size: 0.7em;
            }

            .metric-value {
                font-size: 0.95em;
            }

            .action-btn {
                width: 32px;
                height: 32px;
                font-size: 1em;
            }

            .loading {
                padding: 40px 20px;
            }

            .loading img {
                max-width: 150px !important;
            }

            .console-box {
                max-width: 100%;
                margin: 16px auto 0;
                padding: 12px;
                font-size: 0.75em;
                max-height: 200px;
            }

            .console-line {
                margin: 2px 0;
                font-size: 0.9em;
            }
        }

        @media screen and (max-width: 480px) {
            h1 {
                font-size: 14vw;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-row {
                grid-template-columns: 2fr 0.8fr 0.8fr 0.8fr 28px;
                font-size: 0.75em;
                padding: 10px 6px;
            }

            .pool-name {
                font-size: 0.9em;
            }

            .pool-details {
                font-size: 0.7em;
            }

            .token-icons-pair {
                width: 36px;
                height: 20px;
            }

            .token-icon {
                width: 20px;
                height: 20px;
            }

            .token-icon-fallback {
                width: 20px;
                height: 20px;
                font-size: 0.55em;
            }

            .metric-value {
                font-size: 0.85em;
            }

            .metric-label {
                font-size: 0.65em;
            }

            .action-btn {
                width: 28px;
                height: 28px;
                font-size: 0.9em;
            }

            .timeframe-btn {
                font-size: 0.85em;
                padding: 6px 10px;
            }

            .console-box {
                font-size: 0.7em;
                padding: 10px;
                max-height: 150px;
            }

            .loading img {
                max-width: 120px !important;
            }
        }


        .error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #f87171;
            padding: 24px;
            border-radius: 16px;
            margin: 24px 0;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 8px 32px rgba(239, 68, 68, 0.1);
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 48px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.02) 100%);
            padding: 28px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(40px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        }

        .stat-card:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.03) 100%);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
        }

        .stat-label {
            color: #6b6b6b;
            font-size: 0.688em;
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .stat-value {
            color: #ffffff;
            font-size: 2em;
            font-weight: 700;
            letter-spacing: -0.03em;
            font-variant-numeric: tabular-nums;
        }

        .controls {
            margin-bottom: 36px;
        }

        .search-box {
            width: 100%;
            padding: 18px 24px;
            font-size: 0.938em;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            color: #ffffff;
            margin-bottom: 24px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
        }

        .search-box::placeholder {
            color: #6b6b6b;
        }

        .search-box:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.12);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.03) 100%);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .control-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .timeframe-section {
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 6px 8px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.02) 100%);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .timeframe-label {
            color: #6b6b6b;
            font-size: 0.75em;
            font-weight: 700;
            margin-right: 8px;
            padding-left: 10px;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .timeframe-btn {
            background: transparent;
            color: #6b6b6b;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.813em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            position: relative;
        }

        .timeframe-btn:hover {
            background: rgba(255, 255, 255, 0.06);
            color: #ffffff;
            transform: translateY(-1px);
        }

        .timeframe-btn.active {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.08) 100%);
            color: #ffffff;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .sort-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .sort-label {
            color: #6b6b6b;
            font-size: 0.75em;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .sort-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.02) 100%);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 12px 18px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.813em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
        }

        .sort-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), 0 0 16px rgba(255, 255, 255, 0.15);
        }

        .sort-btn.active {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%);
            border-color: rgba(255, 255, 255, 0.12);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .sort-arrow {
            font-size: 1.1em;
            font-weight: 700;
            opacity: 0.4;
            transition: all 0.3s ease;
        }

        .sort-btn.active .sort-arrow {
            opacity: 1;
        }

        .sort-arrow.desc {
            color: #22c55e;
        }

        .sort-arrow.asc {
            color: #ef4444;
        }

        .refresh-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.02) 100%);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.813em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-left: auto;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), 0 0 16px rgba(255, 255, 255, 0.15);
        }

        .refresh-btn.is-refreshing {
            pointer-events: none;
            opacity: 0.7;
        }

        .refresh-icon {
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .refresh-btn.is-refreshing .refresh-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .pool-table {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0.01) 100%);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            overflow: hidden;
            backdrop-filter: blur(40px);
        }

        .table-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 120px;
            gap: 20px;
            padding: 16px 24px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        @media (max-width: 1024px) {
            .table-header { display: none; }
        }

        .header-cell {
            color: #6b6b6b;
            font-size: 0.688em;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .table-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 120px;
            gap: 20px;
            padding: 16px 24px;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .table-row:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.02) 100%);
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .pool-name-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .token-icons-pair {
            display: flex;
            align-items: center;
            gap: 0px;
            position: relative;
        }

        .token-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            object-fit: cover;
            flex-shrink: 0;
        }

        .token-icon-fallback {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(99, 102, 241, 0.1) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: 700;
            color: #818cf8;
            flex-shrink: 0;
        }

        .token-icon + .token-icon,
        .token-icon + .token-icon-fallback,
        .token-icon-fallback + .token-icon,
        .token-icon-fallback + .token-icon-fallback {
            margin-left: -10px;
            position: relative;
            z-index: 1;
        }

        .pool-name-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .pool-name {
            font-size: 1em;
            font-weight: 600;
            color: #ffffff;
            letter-spacing: -0.01em;
        }

        .pool-meta {
            display: flex;
            gap: 6px;
        }

        .pool-badge {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(99, 102, 241, 0.05) 100%);
            color: #818cf8;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.688em;
            font-weight: 700;
            border: 1px solid rgba(99, 102, 241, 0.2);
            white-space: nowrap;
        }

        .data-cell {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .data-label {
            color: #6b6b6b;
            font-size: 0.625em;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .data-value {
            color: #ffffff;
            font-size: 0.938em;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .action-cell {
            text-align: right;
        }

        .open-pool-btn {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.05) 100%);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.2);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.813em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .open-pool-btn:hover {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.25) 0%, rgba(34, 197, 94, 0.1) 100%);
            border-color: rgba(34, 197, 94, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
        }

        @media (max-width: 768px) {
            h1 { font-size: 12vw; }
            .control-row { flex-direction: column; }
            .table-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>dlmm.markets</h1>
            <p class="subtitle">Meteora Dynamic Liquidity Market Maker</p>
        </header>

        <div id="loading" class="loading" style="display: block;">
            Loading pools...<br>
            <img src="373.gif" alt="Loading..." style="margin-top: 20px; max-width: 200px;">
            <div class="console-box" id="consoleBox"></div>
        </div>

        <div id="error" class="error"></div>

        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card">
                <div class="stat-label">Total Pools</div>
                <div class="stat-value" id="totalPools">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total TVL</div>
                <div class="stat-value" id="totalTVL">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">24h Volume</div>
                <div class="stat-value" id="totalVolume">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">24h Fees</div>
                <div class="stat-value" id="totalFees">$0</div>
            </div>
        </div>

        <div class="controls" id="controls" style="display: none;">
            <input type="text" id="searchBox" class="search-box" placeholder="Search pools...">

            <div class="control-row">
                <div class="timeframe-section">
                    <span class="timeframe-label">Timeframe</span>
                    <button class="timeframe-btn" onclick="setTimeframe('1h')">1H</button>
                    <button class="timeframe-btn active" onclick="setTimeframe('24h')">24H</button>
                    <button class="timeframe-btn" onclick="setTimeframe('7d')">7D</button>
                    <button class="timeframe-btn" onclick="setTimeframe('30m')">30M</button>
                </div>

                <div class="sort-controls">
                    <span class="sort-label">Sort</span>
                    <button class="sort-btn" id="sortTVL" onclick="sortPools('tvl')">
                        <span>TVL</span>
                        <span class="sort-arrow">‚Üï</span>
                    </button>
                    <button class="sort-btn" id="sortVolume" onclick="sortPools('volume')">
                        <span>Volume</span>
                        <span class="sort-arrow">‚Üï</span>
                    </button>
                    <button class="sort-btn active" id="sortFeeRatio" onclick="sortPools('feeRatio')">
                        <span>Fee Ratio</span>
                        <span class="sort-arrow desc">‚Üë</span>
                    </button>
                </div>

                <button class="refresh-btn" id="refreshBtn" onclick="fetchPools()">
                    <span class="refresh-icon">‚Üª</span>
                    <span>Refresh</span>
                </button>
            </div>
        </div>

        <div class="pool-table" id="poolsContainer"></div>
    </div>

    <script>
        let allPools = [];
        let filteredPools = [];
        let currentSort = { field: 'feeRatio', direction: 'desc' };
        let currentTimeframe = '30m';
        let tokenIconsMap = new Map();
        let isInitialLoad = true;
        let isFetching = false;

        // Load cached icons from localStorage
        function loadIconCache() {
            try {
                const cached = localStorage.getItem('tokenIconCache');
                if (cached) {
                    const parsed = JSON.parse(cached);
                    tokenIconsMap = new Map(Object.entries(parsed));
                    console.log('Loaded', tokenIconsMap.size, 'icons from cache');
                }
            } catch (e) {
                console.error('Failed to load icon cache:', e);
            }
        }

        // Save icon cache to localStorage
        function saveIconCache() {
            try {
                const obj = Object.fromEntries(tokenIconsMap);
                localStorage.setItem('tokenIconCache', JSON.stringify(obj));
            } catch (e) {
                console.error('Failed to save icon cache:', e);
            }
        }

        // Fetch token icon from Jupiter API
        async function fetchTokenIcon(mintAddress) {
            if (tokenIconsMap.has(mintAddress)) {
                return tokenIconsMap.get(mintAddress);
            }

            try {
                const response = await fetch(`https://lite-api.jup.ag/tokens/v2/search?query=${mintAddress}`);

                if (!response.ok) {
                    tokenIconsMap.set(mintAddress, null);
                    return null;
                }

                const data = await response.json();

                if (data && data.length > 0 && data[0].icon) {
                    const iconUrl = data[0].icon;
                    tokenIconsMap.set(mintAddress, iconUrl);
                    return iconUrl;
                } else {
                    tokenIconsMap.set(mintAddress, null);
                    return null;
                }
            } catch (error) {
                console.error(`Error fetching token icon for ${mintAddress}:`, error);
                tokenIconsMap.set(mintAddress, null);
                return null;
            }
        }

        function formatNumber(num) {
            if (!num || isNaN(num)) return '0';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toFixed(2);
        }

        function formatPercent(num) {
            if (!num || isNaN(num)) return '0.00';
            return parseFloat(num).toFixed(2);
        }

        function getTimeframeData(pool, dataType) {
            const timeframeMap = {
                '30m': { volume: 'trade_volume_24h', fees: 'fees_24h', feeRatio: pool.fee_tvl_ratio?.min_30 },
                '1h': { volume: 'trade_volume_1h', fees: 'fees_1h', feeRatio: pool.fee_tvl_ratio?.hour_1 },
                '24h': { volume: 'trade_volume_24h', fees: 'fees_24h', feeRatio: pool.fee_tvl_ratio?.hour_24 },
                '7d': { volume: 'trade_volume_7d', fees: 'fees_7d', feeRatio: pool.fee_tvl_ratio?.day_7 }
            };

            const tf = timeframeMap[currentTimeframe];

            if (dataType === 'volume') {
                if (pool.dexscreener_volume) {
                    if (currentTimeframe === '30m') return pool.dexscreener_volume.m5 ? (pool.dexscreener_volume.m5 * 6) : 0;
                    if (currentTimeframe === '1h') return pool.dexscreener_volume.h1 || 0;
                    if (currentTimeframe === '24h') return pool.dexscreener_volume.h24 || 0;
                    if (currentTimeframe === '7d') return (pool.dexscreener_volume.h24 || 0) * 7;
                }
                return parseFloat(pool[tf.volume]) || 0;
            }
            if (dataType === 'fees') return parseFloat(pool[tf.fees]) || 0;
            if (dataType === 'feeRatio') return parseFloat(tf.feeRatio) || 0;
            return 0;
        }

        function setTimeframe(timeframe) {
            currentTimeframe = timeframe;
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            displayStats(allPools);
            if (currentSort.field) {
                applySortWithoutToggle();
            } else {
                displayPools(filteredPools);
            }
        }

        function displayStats(pools) {
            const totalPools = pools.length;
            const totalTVL = pools.reduce((sum, pool) => sum + (parseFloat(pool.liquidity) || 0), 0);
            // Always use 24h data for top stats, ignore currentTimeframe
            const totalVolume = pools.reduce((sum, pool) => sum + (parseFloat(pool.trade_volume_24h) || 0), 0);
            const totalFees = pools.reduce((sum, pool) => sum + (parseFloat(pool.fees_24h) || 0), 0);

            document.getElementById('totalPools').textContent = totalPools;
            document.getElementById('totalTVL').textContent = '$' + formatNumber(totalTVL);
            document.getElementById('totalVolume').textContent = '$' + formatNumber(totalVolume);
            document.getElementById('totalFees').textContent = '$' + formatNumber(totalFees);
        }

        function displayPools(pools) {
            const container = document.getElementById('poolsContainer');
            const timeframeLabels = { '30m': '30M', '1h': '1H', '24h': '24H', '7d': '7D' };
            const timeframeLabel = timeframeLabels[currentTimeframe];

            const tableHeaderHTML = `
                <div class="table-header">
                    <div class="header-cell">Pool</div>
                    <div class="header-cell">TVL</div>
                    <div class="header-cell">Volume (${timeframeLabel})</div>
                    <div class="header-cell">${timeframeLabel} Fee/TVL</div>
                    <div class="header-cell"></div>
                </div>
            `;

            const poolsHTML = pools.map(pool => {
                const volume = getTimeframeData(pool, 'volume');
                const feeRatio = getTimeframeData(pool, 'feeRatio');
                const binStep = pool.bin_step || 'N/A';
                // Try multiple fee sources
                const feePercent = pool.bin_step ? `${(pool.bin_step * 0.01).toFixed(2)}%` : 
                                   pool.trade_fee_pct ? `${(pool.trade_fee_pct * 100).toFixed(2)}%` : 
                                   pool.trade_fee_rate ? `${(pool.trade_fee_rate * 100).toFixed(2)}%` :
                                   pool.fee_bps ? `${(pool.fee_bps / 100).toFixed(2)}%` : '0.00%';

                const tokens = {
                    first: pool.name?.split('-')[0]?.trim() || 'Unknown',
                    second: pool.name?.split('-')[1]?.trim() || 'Unknown'
                };

                const iconX = tokenIconsMap.get(pool.mint_x) || null;
                const iconY = tokenIconsMap.get(pool.mint_y) || null;

                const meteora_url = `https://app.meteora.ag/dlmm/${pool.address}`;

                return `
                <div class="table-row">
                    <div class="pool-name-cell">
                        <div class="token-icons-pair">
                            ${iconX ? `
                                <img src="${iconX}" class="token-icon" alt="${tokens.first}"
                                onerror="console.error('Failed to load icon for ' + '${tokens.first}' + ' - URL: ' + '${iconX}'); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="token-icon-fallback" style="display: none;">
                                    ${tokens.first.substring(0, 2)}
                                </div>
                            ` : `
                                <div class="token-icon-fallback">
                                    ${tokens.first.substring(0, 2)}
                                </div>
                            `}
                            ${iconY ? `
                                <img src="${iconY}" class="token-icon" alt="${tokens.second}"
                                onerror="console.error('Failed to load icon for ' + '${tokens.second}' + ' - URL: ' + '${iconY}'); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="token-icon-fallback" style="display: none;">
                                    ${tokens.second.substring(0, 2)}
                                </div>
                            ` : `
                                <div class="token-icon-fallback">
                                    ${tokens.second.substring(0, 2)}
                                </div>
                            `}
                        </div>
                        <div class="pool-name-info">
                            <div class="pool-name">${pool.name}</div>
                            <div class="pool-meta">
                                <span class="pool-badge">Bin ${binStep}</span>
                                <span class="pool-badge">${feePercent}</span>
                            </div>
                        </div>
                    </div>
                    <div class="data-cell">
                        <span class="data-label">${timeframeLabel} Fee/TVL</span>
                        <span class="data-value">${formatPercent(feeRatio)}%</span>
                    </div>
                    <div class="data-cell">
                        <span class="data-label">Volume (${timeframeLabel})</span>
                        <span class="data-value">$${formatNumber(volume)}</span>
                    </div>
                    <div class="data-cell">
                        <span class="data-label">TVL</span>
                        <span class="data-value">$${formatNumber(pool.liquidity)}</span>
                    </div>
                    <div class="action-cell">
                        <a href="${meteora_url}" target="_blank" rel="noopener noreferrer" class="open-pool-btn">
                            Open ‚Üí
                        </a>
                    </div>
                </div>
                `;
            }).join('');

            container.innerHTML = tableHeaderHTML + poolsHTML;
        }

        function updateSortButtons() {
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
                const arrow = btn.querySelector('.sort-arrow');
                arrow.textContent = '‚Üï';
                arrow.classList.remove('asc', 'desc');
            });

            if (currentSort.field) {
                let btnId;
                if (currentSort.field === 'tvl') btnId = 'sortTVL';
                else if (currentSort.field === 'volume') btnId = 'sortVolume';
                else if (currentSort.field === 'feeRatio') btnId = 'sortFeeRatio';

                if (btnId) {
                    const btn = document.getElementById(btnId);
                    btn.classList.add('active');
                    const arrow = btn.querySelector('.sort-arrow');

                    if (currentSort.direction === 'desc') {
                        arrow.textContent = '‚Üë';
                        arrow.classList.add('desc');
                    } else {
                        arrow.textContent = '‚Üì';
                        arrow.classList.add('asc');
                    }
                }
            }
        }

        function applySortWithoutToggle() {
            const sortedPools = [...filteredPools].sort((a, b) => {
                let aVal, bVal;

                if (currentSort.field === 'tvl') {
                    aVal = parseFloat(a.liquidity) || 0;
                    bVal = parseFloat(b.liquidity) || 0;
                } else if (currentSort.field === 'volume') {
                    aVal = getTimeframeData(a, 'volume');
                    bVal = getTimeframeData(b, 'volume');
                } else if (currentSort.field === 'feeRatio') {
                    aVal = getTimeframeData(a, 'feeRatio');
                    bVal = getTimeframeData(b, 'feeRatio');
                }

                if (currentSort.direction === 'desc') {
                    return bVal - aVal;
                } else {
                    return aVal - bVal;
                }
            });

            updateSortButtons();
            displayPools(sortedPools);
        }

        function sortPools(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'desc' ? 'asc' : 'desc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'desc';
            }

            applySortWithoutToggle();
        }

        function filterPools(searchTerm) {
            filteredPools = allPools.filter(pool => 
                pool.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (currentSort.field) {
                applySortWithoutToggle();
            } else {
                displayPools(filteredPools);
            }
        }

        async function fetchTokenIcons(pools) {
            console.log('Fetching token icons from Jupiter API...');

            const uniqueMints = new Set();
            pools.forEach(pool => {
                if (pool.mint_x) uniqueMints.add(pool.mint_x);
                if (pool.mint_y) uniqueMints.add(pool.mint_y);
            });

            // Filter out already cached mints
            const mintsToFetch = Array.from(uniqueMints).filter(mint => !tokenIconsMap.has(mint));

            if (mintsToFetch.length === 0) {
                console.log('All icons already cached');
                return;
            }

            console.log(`Fetching ${mintsToFetch.length} new icons (${tokenIconsMap.size} already cached)`);

            const batchSize = 10;
            for (let i = 0; i < mintsToFetch.length; i += batchSize) {
                const batch = mintsToFetch.slice(i, i + batchSize);
                await Promise.all(batch.map(mint => fetchTokenIcon(mint)));

                if (i + batchSize < mintsToFetch.length) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }

            console.log('Token icons fetched, total in cache:', tokenIconsMap.size);
            saveIconCache();
        }


        // Console logging functions
        function addConsoleLog(message, type = 'info') {
            const consoleBox = document.getElementById('consoleBox');
            if (!consoleBox) return;

            const line = document.createElement('div');
            line.className = `console-line ${type}`;

            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'console-timestamp';
            timestampSpan.textContent = `[${timestamp}]`;

            line.appendChild(timestampSpan);
            line.appendChild(document.createTextNode(` ${message}`));

            consoleBox.appendChild(line);
            consoleBox.scrollTop = consoleBox.scrollHeight;
        }

        function clearConsoleLog() {
            const consoleBox = document.getElementById('consoleBox');
            if (consoleBox) {
                consoleBox.innerHTML = '';
            }
        }

        // Fetch volume data from DexScreener for a specific pool
        async function fetchDexScreenerVolume(pairAddress) {
            try {
                const response = await fetch(`https://api.dexscreener.com/latest/dex/pairs/solana/${pairAddress}`);
                if (!response.ok) return null;

                const data = await response.json();
                if (data && data.pairs && data.pairs.length > 0) {
                    const pair = data.pairs[0];
                    return {
                        h1: pair.volume?.h1 || 0,
                        h24: pair.volume?.h24 || 0,
                        h6: pair.volume?.h6 || 0,
                        m5: pair.volume?.m5 || 0
                    };
                }
            } catch (error) {
                console.error(`Error fetching DexScreener data for ${pairAddress}:`, error);
            }
            return null;
        }

        // Enrich pools with DexScreener volume data (ONLY on initial load)
        async function enrichPoolsWithVolume(pools, skipDexScreener = false) {
            if (skipDexScreener) {
                console.log('Skipping DexScreener fetch (using cached data)');
                addConsoleLog('‚ÑπÔ∏è Using cached volume data (no DexScreener refresh)', 'info');
                return;
            }

            console.log('Fetching volume data from DexScreener for', pools.length, 'pools...');
            addConsoleLog(`üîÑ Fetching volume data for ${pools.length} pools from DexScreener...`, 'info');
            const batchSize = 10;

            for (let i = 0; i < pools.length; i += batchSize) {
                const batch = pools.slice(i, i + batchSize);
                const batchNum = Math.floor(i / batchSize) + 1;
                const totalBatches = Math.ceil(pools.length / batchSize);

                addConsoleLog(`üìä Processing batch ${batchNum}/${totalBatches} (pools ${i + 1}-${Math.min(i + batchSize, pools.length)})`, 'info');

                await Promise.all(batch.map(async (pool) => {
                    const volumeData = await fetchDexScreenerVolume(pool.address);
                    if (volumeData) {
                        pool.dexscreener_volume = volumeData;
                        addConsoleLog(`  ‚úì ${pool.name}: Volume data fetched`, 'success');
                    } else {
                        addConsoleLog(`  ‚ö† ${pool.name}: Using fallback data`, 'warning');
                    }
                }));

                if (i + batchSize < pools.length) {
                    addConsoleLog(`‚è≥ Waiting 2s before next batch (rate limit)...`, 'info');
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }

            console.log('DexScreener volume data fetched');
            addConsoleLog('‚úì All volume data fetched successfully!', 'success');
            addConsoleLog('üéâ Loading complete - displaying pools...', 'success');
        }

        async function fetchPools(skipDexScreener = false) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const statsGrid = document.getElementById('statsGrid');
            const controls = document.getElementById('controls');
            const container = document.getElementById('poolsContainer');
            const refreshBtn = document.getElementById('refreshBtn');

            refreshBtn.classList.add('is-refreshing');

            if (isInitialLoad) {
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                container.innerHTML = '';
                statsGrid.style.display = 'none';
                controls.style.display = 'none';
            }

            try {
                console.log('Fetching pools from Meteora API...');
                addConsoleLog('üåê Connecting to Meteora API...', 'info');

                const response = await fetch('https://dlmm-api.meteora.ag/pair/all_with_pagination?limit=200&sort_key=feetvlratio30m&order_by=desc&hide_low_tvl=2000');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Data fetched successfully');
                addConsoleLog('‚úì Meteora API response received', 'success');

                allPools = data.pairs || [];
                filteredPools = [...allPools];

                console.log('Total pools loaded:', allPools.length);
                addConsoleLog(`‚úì Loaded ${allPools.length} pools from Meteora`, 'success');

                await fetchTokenIcons(allPools);

                if (isInitialLoad) {
                    loadingEl.style.display = 'none';
                    statsGrid.style.display = 'grid';
                    controls.style.display = 'block';
                    isInitialLoad = false;
                }

                displayStats(allPools);

                if (currentSort.field) {
                    applySortWithoutToggle();
                } else {
                    displayPools(filteredPools);
                }

            } catch (error) {
                console.error('Error fetching pools:', error);
                if (isInitialLoad) {
                    loadingEl.style.display = 'none';
                }
                errorEl.textContent = `Error loading pools: ${error.message}`;
                addConsoleLog(`‚ùå Error: ${error.message}`, 'error');
                errorEl.style.display = 'block';
            } finally {
                refreshBtn.classList.remove('is-refreshing');
                isFetching = false;
            }
        }

        document.getElementById('searchBox').addEventListener('input', (e) => {
            filterPools(e.target.value);
        });

        // Load cached icons on startup
        loadIconCache();

        // Initial fetch
        fetchPools();

        // Auto-refresh every 60 seconds
        setInterval(fetchPools, 60000);

        // Smart logo font rotation with localStorage
        const logoFonts = [
            "'Spectral', serif",
            "'Henny Penny', cursive",
            "'Zilla Slab Highlight', cursive",
            "'Libre Barcode 39 Text', cursive"
        ];

        const lastFont = localStorage.getItem('lastLogoFont');
        let selectedFont;

        if (!lastFont) {
            selectedFont = logoFonts[0];
            console.log('üé® First visit - using Spectral');
        } else {
            const availableFonts = logoFonts.filter(font => font !== lastFont);
            selectedFont = availableFonts[Math.floor(Math.random() * availableFonts.length)];
            console.log('üîÑ Refresh - changed from', lastFont, 'to', selectedFont);
        }

        document.querySelector('h1').style.fontFamily = selectedFont;
        localStorage.setItem('lastLogoFont', selectedFont);
    </script>
</body>
</html>